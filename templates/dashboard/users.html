{% extends 'dashboard/base.html' %}
{% block title %}Foydalanuvchilar — Bot boshqaruvi{% endblock %}
{% block content %}
<h1 class="h4 mb-4">Foydalanuvchilar</h1>
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Foydalanuvchi</th>
                        <th>Telegram ID</th>
                        <th>Yuklashlar</th>
                        <th>Shazam</th>
                        <th>Premium</th>
                        <th>Blok</th>
                        <th>Oxirgi faollik</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>
                            <a href="{% url 'dashboard:user_detail' u.pk %}" class="text-decoration-none fw-medium">{{ u.first_name }} {{ u.last_name|default:"" }}</a>
                            {% if u.username %}<br><small class="text-muted">@{{ u.username }}</small>{% endif %}
                        </td>
                        <td><code>{{ u.telegram_id }}</code></td>
                        <td>{{ u.downloads_count }}</td>
                        <td>{{ u.shazam_count }}</td>
                        <td>
                            <button type="button" class="btn btn-sm {% if u.is_premium %}btn-warning{% else %}btn-outline-secondary{% endif %} btn-action user-premium" data-pk="{{ u.pk }}" data-premium="{{ u.is_premium|yesno:'1,0' }}">
                                {% if u.is_premium %}<i class="bi bi-star-fill"></i> Premium{% else %}<i class="bi bi-star"></i> Yoʻq{% endif %}
                            </button>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm {% if u.is_banned %}btn-danger{% else %}btn-outline-secondary{% endif %} btn-action user-ban" data-pk="{{ u.pk }}" data-banned="{{ u.is_banned|yesno:'1,0' }}">
                                {% if u.is_banned %}<i class="bi bi-lock-fill"></i> Blok{% else %}<i class="bi bi-unlock"></i> Yoʻq{% endif %}
                            </button>
                        </td>
                        <td><small>{{ u.last_active|date:"d.m.Y H:i" }}</small></td>
                        <td>
                            <a href="{% url 'dashboard:user_detail' u.pk %}" class="btn btn-sm btn-outline-primary">Tarix</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" class="text-center text-muted py-4">Foydalanuvchilar yoʻq</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.user-premium').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var pk = this.dataset.pk;
        var formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        fetch('/boshqaruv/foydalanuvchilar/' + pk + '/premium/', { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => r.json()).then(function(data) {
                if (data.ok) {
                    if (data.is_premium) {
                        btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-warning');
                        btn.innerHTML = '<i class="bi bi-star-fill"></i> Premium';
                    } else {
                        btn.classList.remove('btn-warning'); btn.classList.add('btn-outline-secondary');
                        btn.innerHTML = '<i class="bi bi-star"></i> Yoʻq';
                    }
                }
            });
    });
});
document.querySelectorAll('.user-ban').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var pk = this.dataset.pk;
        var formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        fetch('/boshqaruv/foydalanuvchilar/' + pk + '/ban/', { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => r.json()).then(function(data) {
                if (data.ok) {
                    if (data.is_banned) {
                        btn.classList.remove('btn-outline-secondary'); btn.classList.add('btn-danger');
                        btn.innerHTML = '<i class="bi bi-lock-fill"></i> Blok';
                    } else {
                        btn.classList.remove('btn-danger'); btn.classList.add('btn-outline-secondary');
                        btn.innerHTML = '<i class="bi bi-unlock"></i> Yoʻq';
                    }
                }
            });
    });
});
</script>
{% endblock %}
