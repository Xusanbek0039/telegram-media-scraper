{% extends 'dashboard/base.html' %}
{% block title %}Foydalanuvchilar â€” Bot boshqaruvi{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">Foydalanuvchilar</h1>
        <p class="page-subtitle mb-0">Jami: {{ total_count }} | Premium: {{ premium_count }} | Bloklangan: {{ banned_count }}</p>
    </div>
</div>

<!-- Filters -->
<div class="glass-card mb-4">
    <div class="card-body py-3">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-5">
                <input type="text" name="q" class="form-control" placeholder="Username, ism yoki Telegram ID bo'yicha qidirish..." value="{{ search }}">
            </div>
            <div class="col-md-3">
                <select name="filter" class="form-select">
                    <option value="all" {% if filter_type == 'all' %}selected{% endif %}>Barchasi</option>
                    <option value="premium" {% if filter_type == 'premium' %}selected{% endif %}>Premium</option>
                    <option value="banned" {% if filter_type == 'banned' %}selected{% endif %}>Bloklangan</option>
                    <option value="active" {% if filter_type == 'active' %}selected{% endif %}>Aktiv (24s)</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-accent w-100"><i class="bi bi-search"></i> Qidirish</button>
            </div>
            <div class="col-md-2">
                <a href="{% url 'dashboard:users' %}" class="btn btn-glass w-100">Tozalash</a>
            </div>
        </form>
    </div>
</div>

<!-- Users Table -->
<div class="glass-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark-custom mb-0">
                <thead>
                    <tr>
                        <th>Foydalanuvchi</th>
                        <th>Telegram ID</th>
                        <th>Yuklashlar</th>
                        <th>Shazam</th>
                        <th>Status</th>
                        <th>Oxirgi faollik</th>
                        <th>Amallar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>
                            <a href="{% url 'dashboard:user_detail' u.pk %}" class="text-decoration-none" style="color:var(--accent-blue);">
                                {{ u.first_name }} {{ u.last_name|default:"" }}
                            </a>
                            {% if u.username %}<br><small class="text-muted">@{{ u.username }}</small>{% endif %}
                        </td>
                        <td><code style="color:var(--accent-cyan);">{{ u.telegram_id }}</code></td>
                        <td><span class="badge badge-glow badge-purple">{{ u.downloads_count }}</span></td>
                        <td><span class="badge badge-glow badge-info">{{ u.shazam_count }}</span></td>
                        <td>
                            {% if u.is_premium %}<span class="badge badge-glow badge-warning"><i class="bi bi-star-fill"></i> Premium</span>{% endif %}
                            {% if u.is_banned %}<span class="badge badge-glow badge-danger"><i class="bi bi-lock-fill"></i> Blok</span>{% endif %}
                            {% if not u.is_premium and not u.is_banned %}<span class="badge badge-glow badge-success">Oddiy</span>{% endif %}
                        </td>
                        <td><small class="text-muted">{{ u.last_active|date:"d.m.Y H:i" }}</small></td>
                        <td>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm {% if u.is_premium %}btn-warning{% else %}btn-glass{% endif %} user-premium" data-pk="{{ u.pk }}" title="Premium">
                                    <i class="bi bi-star{% if u.is_premium %}-fill{% endif %}"></i>
                                </button>
                                <button type="button" class="btn btn-sm {% if u.is_banned %}btn-danger{% else %}btn-glass{% endif %} user-ban" data-pk="{{ u.pk }}" title="Ban/Unban">
                                    <i class="bi bi-{% if u.is_banned %}lock-fill{% else %}unlock{% endif %}"></i>
                                </button>
                                <a href="{% url 'dashboard:user_detail' u.pk %}" class="btn btn-sm btn-glass" title="Tarix">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center text-muted py-4">Foydalanuvchilar topilmadi</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
var csrf = document.querySelector('meta[name=csrf-token]').getAttribute('content');
function getCookie(n){var c=document.cookie.match('(^|;)\\s*'+n+'\\s*=\\s*([^;]+)');return c?c.pop():'';}
csrf = csrf || getCookie('csrftoken');
document.querySelectorAll('.user-premium').forEach(function(btn){
    btn.addEventListener('click',function(){
        var pk=this.dataset.pk;
        fetch('/boshqaruv/foydalanuvchilar/'+pk+'/premium/',{method:'POST',headers:{'X-CSRFToken':csrf,'X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({csrfmiddlewaretoken:csrf})})
        .then(r=>r.json()).then(function(data){if(data.ok)location.reload();});
    });
});
document.querySelectorAll('.user-ban').forEach(function(btn){
    btn.addEventListener('click',function(){
        var pk=this.dataset.pk;
        fetch('/boshqaruv/foydalanuvchilar/'+pk+'/ban/',{method:'POST',headers:{'X-CSRFToken':csrf,'X-Requested-With':'XMLHttpRequest'},body:new URLSearchParams({csrfmiddlewaretoken:csrf})})
        .then(r=>r.json()).then(function(data){if(data.ok)location.reload();});
    });
});
</script>
{% endblock %}
